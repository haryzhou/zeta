#!/usr/bin/perl
use strict;
use warnings;
use Getopt::Long;
use Data::Dump;
use HTML::Escape qw/escape_html/;
use Net::Stomp;
use JSON::XS;
use Getopt::Long;

my @to;
my @cc;
my @attach;
my $sub;
my $body;
my $simple;
my $rtn = GetOptions(
    "to|t=s"      => \@to,
    "cc|c=s"      => \@cc,
    "attach|a=s"  => \@attach,
    "subject|s=s" => \$sub,
    "body|b=s"    => \$body,
    "simple|m"    => \$simple,
);
unless($rtn) {
    usage();
}
unless(@to) {
    usage();
}
unless($sub && $body) {
    usage();
}

my $stp = Net::Stomp->new({ 
    hostname => $ENV{STOMP_HOST}, 
    port     => $ENV{STOMP_PORT}
});
$stp->connect({ login => 'hello', passcode => 'there' });
$stp->send({ 
    destination => "/queue/$ENV{MAIL_QUEUE}",
    body        => encode_json({
        to     => \@to,
        cc     => \@cc,
        sub    => 'test msg',
        body   => 'test',
        simple => $simple,
    }),
});
$stp->disconnect;

sub usage {
    die <<'EOF';
usage:

    # 一般用法
    zmail -t tailin.liu@yeepay.com -t ding.luo@yeeay.com \
          -c chao.zhou@yeepay.com \
          -a ./zmail -a ./zmail \
          -s subject \
          -b "hello world" \
          -m 

    #  -b - 代表从标志输入读取, 用于管道处理
    cat Run.pm | zmail -t tailin.liu@yeepay.com -a ./Run.pm -s subject -b -

参数说明:
    -t|--to      : 发送给谁, 可以指定多个
    -c|--cc      : 抄送给谁, 可以指定多个
    -a|--attach  : 附件, 可以指定多个附件
    -s|--subject : 邮件标题
    -b|--body    : 邮件正文内容('-b -'代表从标志输入读)
    -m|--sms     : 纯文本内容(适合139邮箱短信) flag

#
# 如果遇到不能auth的情况
# 需要安装
# sudo cpan -i Authen::SASL
#

EOF
}


__END__
zmc -t 18874881230@139.com -s 'test sub' -b 'test body' -m

